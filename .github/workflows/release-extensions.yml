# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# saba-chan-extensions â€” Build & Release Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ìµìŠ¤í…ì…˜ ë””ë ‰í† ë¦¬ë¥¼ pushí•˜ë©´ ìžë™ìœ¼ë¡œ:
#   1. ê° ìµìŠ¤í…ì…˜ì˜ manifest.jsonì„ íŒŒì‹±í•˜ì—¬ ë²„ì „ ì¶”ì¶œ
#   2. registry.json ìƒì„± (ë³¸ì²´ê°€ ì°¸ì¡°)
#   3. ê° ìµìŠ¤í…ì…˜ì„ zipìœ¼ë¡œ ì••ì¶•
#   4. GitHub Releaseë¡œ ë°°í¬
#
# ë³¸ì²´(saba-chan)ëŠ” ì´ ë¦´ë¦¬ì¦ˆì˜ registry.jsonì„ ì½ì–´
# ë¡œì»¬ ìµìŠ¤í…ì…˜ ë²„ì „ê³¼ ë¹„êµ í›„ í•„ìš”í•œ ìµìŠ¤í…ì…˜ë§Œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.

name: Build & Release Extensions

on:
  push:
    branches: [main]
    paths:
      - '*/manifest.json'
      - '**/*.py'
      - '**/*.js'
      - '**/*.go'
      - '**/*.json'
      - '*/i18n/**'
      - '*/gui/**'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'ë²„ì „ ë³€ê²½ì´ ì—†ì–´ë„ ë¦´ë¦¬ì¦ˆë¥¼ ê°•ì œ ìƒì„±í•©ë‹ˆë‹¤'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ Python ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # â”€â”€ ì´ì „ ë¦´ë¦¬ì¦ˆì˜ registry ë‹¤ìš´ë¡œë“œ (ë¹„êµìš©) â”€â”€â”€â”€â”€
      - name: Download previous registry
        id: prev
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .prev
          gh release download --pattern "registry.json" --dir .prev 2>/dev/null \
            && echo "found=true" >> "$GITHUB_OUTPUT" \
            || echo "found=false" >> "$GITHUB_OUTPUT"

      # â”€â”€ ë¹Œë“œ: registry ìƒì„± + zip ì••ì¶• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build registry & package extensions
        id: build
        run: python .github/scripts/build_extensions.py
        env:
          FORCE_RELEASE: ${{ inputs.force_release || 'false' }}
          PREV_REGISTRY: ${{ steps.prev.outputs.found == 'true' && '.prev/registry.json' || '' }}

      # â”€â”€ ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Delete previous releases
        if: steps.build.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ—‘ï¸ Cleaning up old releases..."
          gh release list --limit 100 --json tagName -q '.[].tagName' | while read -r tag; do
            echo "  Deleting release: $tag"
            gh release delete "$tag" --yes --cleanup-tag 2>/dev/null || true
          done

      # â”€â”€ ë¦´ë¦¬ì¦ˆ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: steps.build.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build.outputs.tag }}
          name: ${{ steps.build.outputs.release_name }}
          body_path: dist/RELEASE_BODY.md
          files: |
            dist/registry.json
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ registry.jsonì„ main ë¸Œëžœì¹˜ì—ë„ ì»¤ë°‹ â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update registry.json in repo
        if: steps.build.outputs.should_release == 'true'
        run: |
          cp dist/registry.json registry.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add registry.json
          git diff --cached --quiet || git commit -m "chore: update registry.json [skip ci]"
          git push

      # â”€â”€ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“¦ Extension Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.build.outputs.should_release }}" == "true" ]; then
            echo "âœ… Release created: \`${{ steps.build.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Extension | Version |" >> "$GITHUB_STEP_SUMMARY"
            echo "|-----------|---------|" >> "$GITHUB_STEP_SUMMARY"
            cat dist/summary_table.md >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || true
          else
            echo "â­ï¸ No release needed (no version changes detected)" >> "$GITHUB_STEP_SUMMARY"
          fi
